
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teleprompter & Video Debug Suite</title>
    <script src="https://www.youtube.com/iframe_api"></script>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 0; 
            padding: 20px; 
            background: #1a1a2e;
            color: white;
        }
        .debug-section { 
            margin: 20px 0; 
            padding: 20px; 
            border: 1px solid #444; 
            border-radius: 8px;
            background: #2a2a4e;
        }
        .controls { 
            margin: 10px 0; 
            display: flex; 
            gap: 10px; 
            flex-wrap: wrap;
        }
        button { 
            padding: 10px 20px; 
            font-size: 14px; 
            border: none; 
            border-radius: 5px; 
            cursor: pointer;
            background: #4CAF50;
            color: white;
        }
        button:hover { background: #45a049; }
        button:disabled { background: #666; cursor: not-allowed; }
        .status { 
            background: #333; 
            padding: 10px; 
            margin: 10px 0; 
            border-radius: 5px; 
            font-family: monospace;
        }
        #teleprompterCanvas { 
            border: 2px solid #666; 
            width: 100%; 
            max-width: 800px; 
            height: 400px;
            background: #000;
        }
        #videoContainer { 
            position: relative; 
            width: 100%; 
            max-width: 800px; 
            height: 450px; 
            background: #000;
            border: 2px solid #666;
        }
        .log { 
            background: #1a1a1a; 
            padding: 10px; 
            height: 200px; 
            overflow-y: auto; 
            font-family: monospace; 
            font-size: 12px;
            border: 1px solid #444;
        }
        .progress-bar {
            width: 100%;
            height: 20px;
            background: #333;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(to right, #4CAF50, #2196F3);
            width: 0%;
            transition: width 0.3s ease;
        }
        .sample-data {
            background: #333;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <h1>ðŸ”§ Teleprompter & Video Debug Suite</h1>
    <p>Comprehensive testing environment for narration, teleprompter scrolling, and video segments</p>

    <!-- Sample Data Display -->
    <div class="debug-section">
        <h2>ðŸ“‹ Sample Test Data</h2>
        <div class="sample-data">
            <h3>Intro Narration:</h3>
            <p id="introText">"Welcome to our lesson on Machine Learning fundamentals. In this first segment, we'll explore the basic concepts that form the foundation of artificial intelligence and data science."</p>
            
            <h3>Outro Narration:</h3>
            <p id="outroText">"Excellent work! You've now learned the core principles of Machine Learning. These concepts will serve as building blocks for more advanced topics in our next lesson."</p>
            
            <h3>Video Segment:</h3>
            <p><strong>YouTube ID:</strong> <span id="videoId">dQw4w9WgXcQ</span></p>
            <p><strong>Start Time:</strong> <span id="startTime">10</span> seconds</p>
            <p><strong>End Time:</strong> <span id="endTime">40</span> seconds</p>
            <p><strong>Duration:</strong> <span id="duration">30</span> seconds</p>
        </div>
    </div>

    <!-- Speech Synthesis Test -->
    <div class="debug-section">
        <h2>ðŸŽ¤ Speech Synthesis Test</h2>
        <div class="controls">
            <button onclick="testSpeechSynthesis()">Test Speech Synthesis</button>
            <button onclick="pauseSpeech()">Pause</button>
            <button onclick="resumeSpeech()">Resume</button>
            <button onclick="stopSpeech()">Stop</button>
        </div>
        <div class="status" id="speechStatus">Speech synthesis ready</div>
        <div>
            <label>Volume: <input type="range" id="speechVolume" min="0" max="1" step="0.1" value="1"></label>
            <label>Rate: <input type="range" id="speechRate" min="0.5" max="2" step="0.1" value="1"></label>
        </div>
    </div>

    <!-- Teleprompter Test -->
    <div class="debug-section">
        <h2>ðŸ“œ Teleprompter Scrolling Test</h2>
        <canvas id="teleprompterCanvas"></canvas>
        <div class="controls">
            <button onclick="startTeleprompter('intro')">Test Intro Teleprompter</button>
            <button onclick="startTeleprompter('outro')">Test Outro Teleprompter</button>
            <button onclick="pauseTeleprompter()">Pause Teleprompter</button>
            <button onclick="resumeTeleprompter()">Resume Teleprompter</button>
            <button onclick="stopTeleprompter()">Stop Teleprompter</button>
        </div>
        <div class="progress-bar">
            <div class="progress-fill" id="teleprompterProgress"></div>
        </div>
        <div class="status" id="teleprompterStatus">Teleprompter ready</div>
    </div>

    <!-- YouTube Video Test -->
    <div class="debug-section">
        <h2>ðŸ“¹ YouTube Video Segment Test</h2>
        <div id="videoContainer"></div>
        <div class="controls">
            <button onclick="loadVideoSegment()">Load Video Segment</button>
            <button onclick="playVideo()">Play</button>
            <button onclick="pauseVideo()">Pause</button>
            <button onclick="stopVideo()">Stop</button>
            <button onclick="skipToEnd()">Skip to End</button>
        </div>
        <div class="status" id="videoStatus">Video player ready</div>
    </div>

    <!-- Full Lesson Simulation -->
    <div class="debug-section">
        <h2>ðŸŽ“ Full Lesson Simulation</h2>
        <div class="controls">
            <button onclick="startFullLesson()" id="startLessonBtn">Start Full Lesson</button>
            <button onclick="skipToNext()" id="skipBtn" disabled>Skip Current</button>
            <button onclick="pauseLesson()" id="pauseBtn" disabled>Pause</button>
            <button onclick="resumeLesson()" id="resumeBtn" disabled>Resume</button>
            <button onclick="stopLesson()" id="stopBtn" disabled>Stop Lesson</button>
        </div>
        <div class="status" id="lessonStatus">Ready to start lesson</div>
        <div class="status" id="currentPhase">Phase: Idle</div>
    </div>

    <!-- Debug Log -->
    <div class="debug-section">
        <h2>ðŸ“Š Debug Log</h2>
        <button onclick="clearLog()">Clear Log</button>
        <div class="log" id="debugLog"></div>
    </div>

    <script>
        // Debug logging
        function log(message) {
            const logDiv = document.getElementById('debugLog');
            if (!logDiv) return;
            const timestamp = new Date().toLocaleTimeString();
            logDiv.innerHTML += `[${timestamp}] ${message}<br>`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(`[DEBUG] ${message}`);
        }

        function clearLog() {
            const logDiv = document.getElementById('debugLog');
            if (logDiv) {
                logDiv.innerHTML = '';
            }
        }

        // --- COMPLETE LIST OF GLOBAL VARIABLES --- //
        // This section is now complete to avoid any confusion.
        let currentUtterance = null;
        let youtubePlayer = null;
        let teleprompterInterval = null;
        let teleprompterPaused = false;
        let teleprompterStartTime = null;
        let teleprompterPausedDuration = 0;
        let teleprompterLastPauseTime = null;
        let lessonState = 'idle'; 
        let lessonPhase = 0;

        // --- INITIALIZATION --- //
        window.onload = function() {
            log('Debug suite initialized');
            setupCanvas();
            checkSpeechSynthesis();
            updateLessonButtons(false);
        };

        // This is called by the YouTube script tag when it's ready.
        window.onYouTubeIframeAPIReady = function() {
            log('YouTube API ready');
        };

        function setupCanvas() {
            const canvas = document.getElementById('teleprompterCanvas');
            if (canvas) {
                canvas.width = canvas.offsetWidth;
                canvas.height = 400;
                log('Canvas setup complete');
            }
        }

        function checkSpeechSynthesis() {
            if (typeof speechSynthesis !== 'undefined') {
                log('Speech synthesis available');
                speechSynthesis.onvoiceschanged = () => {
                    const voices = speechSynthesis.getVoices();
                    log(`${voices.length} voices loaded`);
                };
            } else {
                log('Speech synthesis NOT available');
            }
        }

        // --- MODIFIED SPEECH SYNTHESIS FUNCTIONS (Implementing the Android Hack) --- //

        function testSpeechSynthesis() {
            const text = document.getElementById('introText').textContent;
            log('Testing speech synthesis...');

            // Cancel any previous speech to ensure a clean start
            if (speechSynthesis.speaking || speechSynthesis.paused) {
                speechSynthesis.cancel();
            }

            // Create the single utterance we will work with for pause/resume
            currentUtterance = new SpeechSynthesisUtterance(text);
            currentUtterance.volume = parseFloat(document.getElementById('speechVolume').value);
            currentUtterance.rate = parseFloat(document.getElementById('speechRate').value);

            currentUtterance.onstart = () => {
                log('Speech started');
                document.getElementById('speechStatus').textContent = 'Speaking...';
            };
            currentUtterance.onend = () => {
                log('Speech ended');
                document.getElementById('speechStatus').textContent = 'Speech complete';
                currentUtterance = null; // Important: Clear the utterance when it's naturally finished
            };
            currentUtterance.onerror = (e) => {
                log(`Speech error: ${e.error}`);
                // Prevent "interrupted" error from showing on a normal stop action
                if (e.error !== 'interrupted') {
                    document.getElementById('speechStatus').textContent = `Error: ${e.error}`;
                }
            };

            speechSynthesis.speak(currentUtterance);
        }

        function pauseSpeech() {
            if (speechSynthesis.speaking) {
                speechSynthesis.pause();
                log('Speech paused');
                document.getElementById('speechStatus').textContent = 'Speech paused';
            } else {
                log('Cannot pause - not speaking');
            }
        }

        function resumeSpeech() {
            if (currentUtterance && speechSynthesis.paused) {
                log('Attempting to resume speech...');
                speechSynthesis.resume();

                // This is the specific hack for Chrome on Android from the Stack Overflow link.
                // A timeout gives the browser a moment to process the resume() call
                // before we apply the speak() hack to force it to play from the paused position.
                setTimeout(() => {
                    if (speechSynthesis.paused) {
                        log('Applying Android resume-fix by re-speaking...');
                        speechSynthesis.speak(currentUtterance);
                    }
                }, 50);

            } else {
                log('Cannot resume - no paused speech available');
            }
        }

        function stopSpeech() {
            speechSynthesis.cancel();
            log('Speech stopped');
            document.getElementById('speechStatus').textContent = 'Speech stopped';
            currentUtterance = null; // Ensure utterance is cleared on stop
        }

        // Teleprompter Functions
        function startTeleprompter(type) {
            const text = type === 'intro' ? 
                document.getElementById('introText').textContent : 
                document.getElementById('outroText').textContent;
            
            log(`Starting ${type} teleprompter`);
            stopTeleprompter(); // Stop any existing teleprompter
            
            teleprompterStartTime = Date.now();
            teleprompterPausedDuration = 0;
            teleprompterPaused = false;
            
            const canvas = document.getElementById('teleprompterCanvas');
            const ctx = canvas.getContext('2d');
            
            // Estimate duration based on text length (average reading speed)
            const words = text.split(' ').length;
            const estimatedDuration = (words / 180) * 60 * 1000; // 180 WPM
            
            log(`Estimated duration: ${Math.round(estimatedDuration/1000)} seconds`);
            
            teleprompterInterval = setInterval(() => {
                if (!teleprompterPaused) {
                    const elapsed = Date.now() - teleprompterStartTime - teleprompterPausedDuration;
                    const progress = Math.min(elapsed / estimatedDuration, 1);
                    const charIndex = Math.floor(progress * text.length);
                    
                    updateTeleprompterDisplay(text, charIndex, progress);
                    
                    if (progress >= 1) {
                        stopTeleprompter();
                        log('Teleprompter complete');
                        document.getElementById('teleprompterStatus').textContent = 'Teleprompter complete';
                    }
                }
            }, 100);
            
            document.getElementById('teleprompterStatus').textContent = `Playing ${type} teleprompter...`;
        }

        function updateTeleprompterDisplay(text, charIndex, progress) {
            const canvas = document.getElementById('teleprompterCanvas');
            const ctx = canvas.getContext('2d');
            
            // Clear canvas
            ctx.fillStyle = '#1a1a2e';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // Add gradient background
            const gradient = ctx.createLinearGradient(0, 0, canvas.width, canvas.height);
            gradient.addColorStop(0, '#1a1a2e');
            gradient.addColorStop(1, '#16213e');
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // Text settings
            const fontSize = 24;
            const lineHeight = fontSize + 8;
            const maxWidth = canvas.width * 0.9;
            
            ctx.font = `${fontSize}px Arial, sans-serif`;
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            
            // Wrap text
            const lines = wrapText(ctx, text, maxWidth);
            
            // Calculate current line
            let currentLineIndex = 0;
            let charsSoFar = 0;
            
            for (let i = 0; i < lines.length; i++) {
                if (charIndex <= charsSoFar + lines[i].length) {
                    currentLineIndex = i;
                    break;
                }
                charsSoFar += lines[i].length + 1;
            }
            
            // Calculate scroll offset
            const yOffset = currentLineIndex * lineHeight;
            const startY = canvas.height / 2 - yOffset;
            
            // Draw lines with color coding
            charsSoFar = 0;
            for (let i = 0; i < lines.length; i++) {
                const lineY = startY + (i * lineHeight);
                const line = lines[i];
                const lineStart = charsSoFar;
                const lineEnd = charsSoFar + line.length;
                
                // Determine line color
                let color;
                if (charIndex > lineEnd) {
                    color = 'rgba(34, 197, 94, 0.7)'; // Green (read)
                } else if (charIndex >= lineStart && charIndex <= lineEnd) {
                    color = 'rgba(255, 255, 255, 1)'; // White (current)
                    // Highlight current line
                    ctx.fillStyle = 'rgba(59, 130, 246, 0.1)';
                    ctx.fillRect(0, lineY - lineHeight/2, canvas.width, lineHeight);
                } else {
                    color = 'rgba(255, 255, 255, 0.5)'; // Dim (upcoming)
                }
                
                ctx.fillStyle = color;
                ctx.fillText(line, canvas.width / 2, lineY);
                
                charsSoFar += line.length + 1;
            }
            
            // Update progress bar
            document.getElementById('teleprompterProgress').style.width = `${progress * 100}%`;
        }

        function wrapText(ctx, text, maxWidth) {
            const words = text.split(' ');
            const lines = [];
            let currentLine = '';
            
            for (let i = 0; i < words.length; i++) {
                const testLine = currentLine + words[i] + ' ';
                const metrics = ctx.measureText(testLine);
                
                if (metrics.width > maxWidth && i > 0) {
                    lines.push(currentLine.trim());
                    currentLine = words[i] + ' ';
                } else {
                    currentLine = testLine;
                }
            }
            lines.push(currentLine.trim());
            return lines;
        }

        function pauseTeleprompter() {
            if (!teleprompterPaused && teleprompterInterval) {
                teleprompterPaused = true;
                teleprompterLastPauseTime = Date.now();
                log('Teleprompter paused');
                document.getElementById('teleprompterStatus').textContent = 'Teleprompter paused';
            }
        }

        function resumeTeleprompter() {
            if (teleprompterPaused && teleprompterInterval) {
                teleprompterPausedDuration += Date.now() - teleprompterLastPauseTime;
                teleprompterPaused = false;
                log('Teleprompter resumed');
                document.getElementById('teleprompterStatus').textContent = 'Teleprompter playing...';
            }
        }

        function stopTeleprompter() {
            if (teleprompterInterval) {
                clearInterval(teleprompterInterval);
                teleprompterInterval = null;
            }
            teleprompterPaused = false;
            document.getElementById('teleprompterProgress').style.width = '0%';
            
            // Clear canvas
            const canvas = document.getElementById('teleprompterCanvas');
            const ctx = canvas.getContext('2d');
            ctx.fillStyle = '#1a1a2e';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            log('Teleprompter stopped');
            document.getElementById('teleprompterStatus').textContent = 'Teleprompter stopped';
        }

        // YouTube Video Functions
        function loadVideoSegment() {
            const videoId = document.getElementById('videoId').textContent;
            const startTime = parseInt(document.getElementById('startTime').textContent);
            const endTime = parseInt(document.getElementById('endTime').textContent);
            
            log(`Loading video segment: ${videoId} (${startTime}s - ${endTime}s)`);
            
            if (youtubePlayer) {
                youtubePlayer.destroy();
            }
            
            youtubePlayer = new YT.Player('videoContainer', {
                height: '100%',
                width: '100%',
                videoId: videoId,
                playerVars: {
                    autoplay: 0,
                    controls: 1,
                    start: startTime,
                    end: endTime,
                    rel: 0,
                    modestbranding: 1
                },
                events: {
                    onReady: (event) => {
                        log('YouTube player ready');
                        document.getElementById('videoStatus').textContent = 'Video loaded and ready';
                    },
                    onStateChange: (event) => {
                        let state = 'unknown';
                        switch(event.data) {
                            case YT.PlayerState.UNSTARTED: state = 'unstarted'; break;
                            case YT.PlayerState.ENDED: state = 'ended'; break;
                            case YT.PlayerState.PLAYING: state = 'playing'; break;
                            case YT.PlayerState.PAUSED: state = 'paused'; break;
                            case YT.PlayerState.BUFFERING: state = 'buffering'; break;
                            case YT.PlayerState.CUED: state = 'cued'; break;
                        }
                        log(`Video state changed: ${state}`);
                        document.getElementById('videoStatus').textContent = `Video: ${state}`;
                        
                        if (event.data === YT.PlayerState.ENDED) {
                            log('Video segment ended');
                            if (lessonState === 'video') {
                                // Auto-advance to outro in full lesson mode
                                setTimeout(() => startOutro(), 1000);
                            }
                        }
                    },
                    onError: (error) => {
                        log(`YouTube error: ${error.data}`);
                        document.getElementById('videoStatus').textContent = `Video error: ${error.data}`;
                    }
                }
            });
        }

        function playVideo() {
            if (youtubePlayer && youtubePlayer.playVideo) {
                youtubePlayer.playVideo();
                log('Video play requested');
            }
        }

        function pauseVideo() {
            if (youtubePlayer && youtubePlayer.pauseVideo) {
                youtubePlayer.pauseVideo();
                log('Video pause requested');
            }
        }

        function stopVideo() {
            if (youtubePlayer && youtubePlayer.stopVideo) {
                youtubePlayer.stopVideo();
                log('Video stop requested');
            }
        }

        function skipToEnd() {
            const endTime = parseInt(document.getElementById('endTime').textContent);
            if (youtubePlayer && youtubePlayer.seekTo) {
                youtubePlayer.seekTo(endTime - 2, true);
                log(`Skipped to end (${endTime - 2}s)`);
            }
        }

        // Full Lesson Simulation
        function startFullLesson() {
            log('Starting full lesson simulation');
            lessonState = 'intro';
            lessonPhase = 0;
            
            updateLessonButtons(true);
            document.getElementById('lessonStatus').textContent = 'Lesson in progress';
            document.getElementById('currentPhase').textContent = 'Phase: Starting intro narration';
            
            startIntro();
        }

        function startIntro() {
            log('Starting intro phase');
            lessonState = 'intro';
            document.getElementById('currentPhase').textContent = 'Phase: Intro narration';
            
            // Start teleprompter
            startTeleprompter('intro');
            
            // Start speech synthesis with teleprompter sync
            const text = document.getElementById('introText').textContent;
            
            if (currentUtterance) {
                speechSynthesis.cancel();
            }

            currentUtterance = new SpeechSynthesisUtterance(text);
            currentUtterance.volume = 1.0;
            currentUtterance.rate = 1.0;

            currentUtterance.onend = () => {
                log('Intro narration complete, starting video');
                setTimeout(() => startVideoPhase(), 1000);
            };

            currentUtterance.onerror = (error) => {
                log(`Intro speech error: ${error.error}`);
                setTimeout(() => startVideoPhase(), 2000);
            };

            speechSynthesis.speak(currentUtterance);
        }

        function startVideoPhase() {
            log('Starting video phase');
            lessonState = 'video';
            document.getElementById('currentPhase').textContent = 'Phase: Video segment';
            
            stopTeleprompter();
            loadVideoSegment();
            
            // Auto-play video after loading
            setTimeout(() => {
                playVideo();
            }, 2000);
        }

        function startOutro() {
            log('Starting outro phase');
            lessonState = 'outro';
            document.getElementById('currentPhase').textContent = 'Phase: Outro narration';
            
            // Start teleprompter
            startTeleprompter('outro');
            
            // Start speech synthesis
            const text = document.getElementById('outroText').textContent;
            
            if (currentUtterance) {
                speechSynthesis.cancel();
            }

            currentUtterance = new SpeechSynthesisUtterance(text);
            currentUtterance.volume = 1.0;
            currentUtterance.rate = 1.0;

            currentUtterance.onend = () => {
                log('Outro narration complete - lesson finished');
                completeLesson();
            };

            currentUtterance.onerror = (error) => {
                log(`Outro speech error: ${error.error}`);
                completeLesson();
            };

            speechSynthesis.speak(currentUtterance);
        }

        function completeLesson() {
            log('Lesson complete');
            lessonState = 'complete';
            document.getElementById('currentPhase').textContent = 'Phase: Complete';
            document.getElementById('lessonStatus').textContent = 'Lesson completed successfully!';
            
            stopTeleprompter();
            updateLessonButtons(false);
        }

        function skipToNext() {
            log('Skipping to next phase');
            
            switch(lessonState) {
                case 'intro':
                    stopSpeech();
                    stopTeleprompter();
                    startVideoPhase();
                    break;
                case 'video':
                    stopVideo();
                    startOutro();
                    break;
                case 'outro':
                    stopSpeech();
                    stopTeleprompter();
                    completeLesson();
                    break;
            }
        }

        function pauseLesson() {
            log('Pausing lesson');
            
            switch(lessonState) {
                case 'intro':
                case 'outro':
                    pauseSpeech();
                    pauseTeleprompter();
                    break;
                case 'video':
                    pauseVideo();
                    break;
            }
            
            document.getElementById('pauseBtn').disabled = true;
            document.getElementById('resumeBtn').disabled = false;
        }

        function resumeLesson() {
            log('Resuming lesson');
            
            switch(lessonState) {
                case 'intro':
                case 'outro':
                    resumeSpeech();
                    resumeTeleprompter();
                    break;
                case 'video':
                    playVideo();
                    break;
            }
            
            document.getElementById('pauseBtn').disabled = false;
            document.getElementById('resumeBtn').disabled = true;
        }

        function stopLesson() {
            log('Stopping lesson');
            
            stopSpeech();
            stopTeleprompter();
            stopVideo();
            
            lessonState = 'idle';
            document.getElementById('currentPhase').textContent = 'Phase: Idle';
            document.getElementById('lessonStatus').textContent = 'Lesson stopped';
            
            updateLessonButtons(false);
        }

        function updateLessonButtons(lessonActive) {
            document.getElementById('startLessonBtn').disabled = lessonActive;
            document.getElementById('skipBtn').disabled = !lessonActive;
            document.getElementById('pauseBtn').disabled = !lessonActive;
            document.getElementById('resumeBtn').disabled = true;
            document.getElementById('stopBtn').disabled = !lessonActive;
        }

        // Initialize lesson buttons
        updateLessonButtons(false);
        
        log('Debug suite ready - all functions loaded');
    </script>
</body>
</html>
