<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Full Debug Suite (Corrected & Complete)</title>
    <script src="https://www.youtube.com/iframe_api"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background: #1a1a2e;
            color: white;
        }

        .debug-section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #444;
            border-radius: 8px;
            background: #2a2a4e;
        }

        .controls {
            margin: 10px 0;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
        }

        button {
            padding: 10px 20px;
            font-size: 14px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            background: #4CAF50;
            color: white;
        }

        button:hover {
            background: #45a049;
        }

        button:disabled {
            background: #666;
            cursor: not-allowed;
        }

        .status {
            background: #333;
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            font-family: monospace;
        }

        #teleprompterCanvas {
            border: 2px solid #666;
            width: 100%;
            max-width: 800px;
            height: 400px;
            background: #000;
        }

        #videoContainer {
            position: relative;
            width: 100%;
            max-width: 800px;
            height: 450px;
            background: #000;
        }

        .log {
            background: #1a1a1a;
            padding: 10px;
            height: 200px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
            border: 1px solid #444;
        }
    </style>
</head>

<body>
    <h1>üîß Full Debug Suite (Final Version)</h1>

    <div class="debug-section">
        <h2>üìã Sample Test Data</h2>
        <p id="introText">"Welcome to our lesson on Machine Learning fundamentals. In this first segment, we'll explore
            the basic concepts that form the foundation of artificial intelligence and data science."</p>
    </div>

    <div class="debug-section">
        <h2>üé§ Speech Synthesis Test</h2>
        <div class="controls">
            <button onclick="SpeechService.play(document.getElementById('introText').textContent)">Test Speech</button>
            <button onclick="SpeechService.pause()">Pause</button>
            <button onclick="SpeechService.resume()">Resume</button>
            <button onclick="SpeechService.stop()">Stop</button>
        </div>
        <div class="status" id="speechStatus">Ready</div>
    </div>

    <div class="debug-section">
        <h2>üìú Teleprompter Scrolling Test</h2>
        <canvas id="teleprompterCanvas"></canvas>
        <div class="controls">
            <button onclick="startTeleprompter()">Test Teleprompter</button>
            <button onclick="pauseTeleprompter()">Pause Teleprompter</button>
            <button onclick="resumeTeleprompter()">Resume Teleprompter</button>
            <button onclick="stopTeleprompter()">Stop Teleprompter</button>
        </div>
        <div class="status" id="teleprompterStatus">Ready</div>
    </div>

    <div class="debug-section">
        <h2>üîç YouTube Keyword Search Test</h2>
        <div class="controls">
            <input type="text" id="youtubeSearchQuery" placeholder="Enter search keywords..."
                style="flex-grow:1; padding: 8px;">
            <button onclick="searchYouTube()">Search</button>
        </div>
        <div id="youtubeSearchResults" style="margin-top: 10px; max-height: 300px; overflow-y: auto;"></div>
    </div>

    <div class="debug-section">
        <h2>üìπ YouTube Video Segment Test</h2>
        <p><strong>Selected Video ID:</strong> <span id="videoId">dQw4w9WgXcQ</span></p>
        <p><strong>Start Time:</strong> <input type="number" id="startTime" value="10" style="width: 50px;">s |
            <strong>End Time:</strong> <input type="number" id="endTime" value="40" style="width: 50px;">s</p>
        <div id="videoContainer" style="margin-top:10px;"></div>
        <div class="controls">
            <button onclick="loadVideoSegment()">Load Video Segment</button>
        </div>
        <div class="status" id="videoStatus">Video player ready</div>
    </div>

    <div class="debug-section">
        <h2>üîß Network Debugging</h2>
        <div class="controls">
            <button onclick="testAPIConnectivity()">Test API Connectivity</button>
            <button onclick="testAPIKeyQuota()">Check API Quota</button>
            <button onclick="validateCSEConfig()">Validate CSE Config</button>
        </div>
        <div class="status" id="networkStatus">Ready for network tests</div>
    </div>

    <div class="debug-section">
        <h2>üìä Debug Log</h2>
        <button onclick="clearLog()">Clear Log</button>
        <div class="log" id="debugLog"></div>
    </div>

    <script>
        // --- UTILITIES & GLOBAL STATE ---
        function log(message) {
            const logDiv = document.getElementById('debugLog');
            if (logDiv) logDiv.innerHTML += `[${new Date().toLocaleTimeString()}] ${message}<br>`;
        }
        function clearLog() {document.getElementById('debugLog').innerHTML = '';}

        let youtubePlayer = null;
        const GOOGLE_API_KEY = 'AIzaSyDbxmMIxsnVWW16iHrVrq1kNe9KTTSpNH4';
        const CSE_ID = 'b53121b78d1c64563';

        window.onload = () => {
            log('Debug suite initialized.');
            
            // Debug API configuration
            log(`=== API CONFIGURATION DEBUG ===`);
            log(`Google API Key: ${GOOGLE_API_KEY}`);
            log(`CSE ID: ${CSE_ID}`);
            log(`API Key length: ${GOOGLE_API_KEY.length}`);
            log(`CSE ID length: ${CSE_ID.length}`);
            
            // Test if we can make basic requests
            testAPIConnectivity();
        };
        window.onYouTubeIframeAPIReady = () => {log('YouTube API ready.');};

        async function testAPIConnectivity() {
            log(`=== TESTING API CONNECTIVITY ===`);
            
            // Test 1: Basic Custom Search API endpoint
            try {
                const testUrl = `https://www.googleapis.com/customsearch/v1?key=${GOOGLE_API_KEY}&cx=${CSE_ID}&q=test`;
                log(`Testing basic connectivity to: ${testUrl}`);
                
                const response = await fetch(testUrl);
                log(`Test Response Status: ${response.status} ${response.statusText}`);
                
                if (response.status === 403) {
                    log(`403 Forbidden - Possible quota exceeded or API key restrictions`);
                } else if (response.status === 400) {
                    log(`400 Bad Request - Check API key and CSE ID format`);
                } else if (response.status === 404) {
                    log(`404 Not Found - API key might be invalid or Custom Search API not enabled`);
                }
                
                const responseText = await response.text();
                log(`Test Response Body (first 500 chars): ${responseText.substring(0, 500)}`);
                
            } catch (error) {
                log(`API connectivity test failed: ${error.message}`);
            }
            
            // Test 2: Check if CSE exists
            log(`=== TESTING CSE CONFIGURATION ===`);
            log(`CSE ID format check: ${/^[a-zA-Z0-9]+$/.test(CSE_ID) ? 'Valid format' : 'Invalid format'}`);
            
            // Test 3: Check API key format
            log(`=== TESTING API KEY FORMAT ===`);
            log(`API Key format check: ${/^AIza[a-zA-Z0-9_-]{35}$/.test(GOOGLE_API_KEY) ? 'Valid format' : 'Invalid format'}`);
        }

        // --- SPEECH SERVICE with Pause/Resume for Audio ---
        const SpeechService = {
            apiUrl: 'https://texttospeech.googleapis.com/v1/text:synthesize',
            audioElement: new Audio(),

            async play(text, {onProgress = null, onComplete = null} = {}) {
                this.stop();
                try {
                    const response = await fetch(`${this.apiUrl}?key=${GOOGLE_API_KEY}`, {
                        method: 'POST', body: JSON.stringify({
                            input: {text},
                            voice: {languageCode: 'en-US', name: 'en-US-Standard-C'},
                            audioConfig: {audioEncoding: 'MP3'}
                        })
                    });
                    if (!response.ok) throw new Error(`API Error: ${(await response.json()).error.message}`);
                    const data = await response.json();
                    const audioBlob = this.base64ToBlob(data.audioContent, 'audio/mpeg');
                    this.audioElement.src = URL.createObjectURL(audioBlob);
                    this.audioElement.play();

                    this.audioElement.ontimeupdate = () => {
                        if (onProgress && this.audioElement.duration) {
                            onProgress(this.audioElement.currentTime / this.audioElement.duration);
                        }
                    };
                    this.audioElement.onended = () => {
                        if (onProgress) onProgress(1);
                        if (onComplete) onComplete();
                    };
                } catch (error) {
                    log(`SpeechService Error: ${error.message}`);
                    if (onComplete) onComplete();
                }
            },
            pause() {if (this.audioElement) this.audioElement.pause();},
            resume() {if (this.audioElement) this.audioElement.play();},
            stop() {
                if (this.audioElement) {
                    this.audioElement.onended = null;
                    this.audioElement.ontimeupdate = null;
                    this.audioElement.pause();
                    this.audioElement.currentTime = 0;
                }
            },
            base64ToBlob(base64, contentType) {
                const byteCharacters = atob(base64);
                const byteArrays = [];
                for (let offset = 0; offset < byteCharacters.length; offset += 512) {
                    const slice = byteCharacters.slice(offset, offset + 512);
                    const byteNumbers = new Array(slice.length);
                    for (let i = 0; i < slice.length; i++) byteNumbers[i] = slice.charCodeAt(i);
                    byteArrays.push(new Uint8Array(byteNumbers));
                }
                return new Blob(byteArrays, {type: contentType});
            }
        };

        // --- TELEPROMPTER & YOUTUBE FUNCTIONS ---
        function startTeleprompter() {
            const text = document.getElementById('introText').textContent;
            const onProgress = (progress) => updateTeleprompterDisplay(text, progress);
            SpeechService.play(text, {onProgress});
        }
        function pauseTeleprompter() {SpeechService.pause();}
        function resumeTeleprompter() {SpeechService.resume();}
        function stopTeleprompter() {SpeechService.stop();}

        function updateTeleprompterDisplay(fullText, progress) {
            const canvas = document.getElementById('teleprompterCanvas');
            const ctx = canvas.getContext('2d');
            canvas.width = canvas.offsetWidth;
            canvas.height = canvas.offsetHeight;
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = '#1a1a2e';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.font = '28px Arial';
            ctx.textAlign = 'center';
            ctx.fillStyle = 'white';
            const lines = wrapText(ctx, fullText, canvas.width * 0.9);
            const lineHeight = 36;
            const totalContentHeight = (lines.length - 1) * lineHeight;
            const yOffset = (canvas.height / 2) - (totalContentHeight * progress);
            ctx.save();
            ctx.translate(canvas.width / 2, yOffset);
            lines.forEach((line, index) => ctx.fillText(line, 0, index * lineHeight));
            ctx.restore();
        }

        function wrapText(ctx, text, maxWidth) {
            const words = text.split(' ');
            let lines = [];
            let currentLine = words[0];
            for (let i = 1; i < words.length; i++) {
                let testLine = currentLine + " " + words[i];
                if (ctx.measureText(testLine).width > maxWidth && currentLine.length > 0) {
                    lines.push(currentLine);
                    currentLine = words[i];
                } else {
                    currentLine = testLine;
                }
            }
            lines.push(currentLine);
            return lines;
        }

        async function searchYouTube() {
            const query = document.getElementById('youtubeSearchQuery').value;
            if (!query) {log('Please enter a search query.'); return;}
            
            log(`=== DEBUGGING GOOGLE CUSTOM SEARCH API ===`);
            log(`Query: "${query}"`);
            log(`API Key: ${GOOGLE_API_KEY}`);
            log(`CSE ID: ${CSE_ID}`);

            const searchParams = new URLSearchParams({
                key: GOOGLE_API_KEY,
                cx: CSE_ID,
                q: query
            });
            
            const fullUrl = `https://www.googleapis.com/customsearch/v1?${searchParams}`;
            log(`Full Request URL: ${fullUrl}`);
            
            try {
                log('Making API request...');
                const response = await fetch(fullUrl);
                
                log(`Response Status: ${response.status} ${response.statusText}`);
                log(`Response Headers: ${JSON.stringify([...response.headers.entries()])}`);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    log(`Error Response Body: ${errorText}`);
                    
                    // Try to parse as JSON for better error details
                    try {
                        const errorData = JSON.parse(errorText);
                        log(`Parsed Error Data: ${JSON.stringify(errorData, null, 2)}`);
                        
                        if (errorData.error) {
                            log(`Error Code: ${errorData.error.code}`);
                            log(`Error Message: ${errorData.error.message}`);
                            log(`Error Details: ${JSON.stringify(errorData.error.details || 'No details')}`);
                        }
                    } catch (parseError) {
                        log(`Could not parse error response as JSON: ${parseError.message}`);
                    }
                    
                    displayYouTubeResults([]);
                    return;
                }
                
                const data = await response.json();
                log(`Response Data: ${JSON.stringify(data, null, 2)}`);
                log(`Items found: ${data.items ? data.items.length : 0}`);
                
                if (data.searchInformation) {
                    log(`Search Information: ${JSON.stringify(data.searchInformation, null, 2)}`);
                }
                
                displayYouTubeResults(data.items);
                
            } catch (fetchError) {
                log(`Fetch Error: ${fetchError.message}`);
                log(`Error Stack: ${fetchError.stack}`);
                displayYouTubeResults([]);
            }
        }

        function displayYouTubeResults(items) {
            const resultsContainer = document.getElementById('youtubeSearchResults');
            resultsContainer.innerHTML = '';
            if (!items || items.length === 0) {
                resultsContainer.innerHTML = '<p>No results found.</p>';
                return;
            }
            items.forEach(item => {
                const url = new URL(item.link);
                const videoId = url.searchParams.get('v');
                if (!videoId) return;

                const title = item.title;
                const thumbnail = item.pagemap?.cse_thumbnail?.[0]?.src || '';

                const resultEl = document.createElement('div');
                resultEl.style.cssText = 'display:flex; align-items:center; margin-bottom:10px; cursor:pointer;';
                resultEl.innerHTML = `
                    <img src="${thumbnail}" style="width:120px; height:90px; margin-right:10px; object-fit:cover;">
                    <div style="flex-grow:1;">
                        <p style="margin:0; font-weight:bold;">${title}</p>
                    </div>
                `;
                resultEl.onclick = () => selectYouTubeVideo(videoId);
                resultsContainer.appendChild(resultEl);
            });
        }

        function selectYouTubeVideo(videoId) {
            log(`Selected video: ${videoId}`);
            document.getElementById('videoId').textContent = videoId;
        }

        function loadVideoSegment() {
            if (youtubePlayer) youtubePlayer.destroy();
            youtubePlayer = new YT.Player('videoContainer', {
                height: '100%', width: '100%',
                videoId: document.getElementById('videoId').textContent,
                playerVars: {
                    autoplay: 1,
                    start: parseInt(document.getElementById('startTime').value),
                    end: parseInt(document.getElementById('endTime').value),
                    origin: window.location.origin
                }
            });
        }

        async function testAPIKeyQuota() {
            log(`=== TESTING API QUOTA ===`);
            const networkStatus = document.getElementById('networkStatus');
            networkStatus.textContent = 'Testing API quota...';
            
            try {
                // Make a minimal request to check quota
                const response = await fetch(`https://www.googleapis.com/customsearch/v1?key=${GOOGLE_API_KEY}&cx=${CSE_ID}&q=test&num=1`);
                
                if (response.status === 429) {
                    log(`Quota exceeded - too many requests`);
                    networkStatus.textContent = 'Quota exceeded';
                } else if (response.status === 403) {
                    const data = await response.json();
                    if (data.error && data.error.message.includes('quota')) {
                        log(`Daily quota exceeded: ${data.error.message}`);
                        networkStatus.textContent = 'Daily quota exceeded';
                    } else {
                        log(`Access forbidden: ${data.error.message}`);
                        networkStatus.textContent = 'Access forbidden';
                    }
                } else if (response.ok) {
                    log(`API quota OK - request successful`);
                    networkStatus.textContent = 'API quota OK';
                } else {
                    log(`Unexpected response: ${response.status} ${response.statusText}`);
                    networkStatus.textContent = `Error: ${response.status}`;
                }
            } catch (error) {
                log(`Quota test failed: ${error.message}`);
                networkStatus.textContent = 'Quota test failed';
            }
        }

        async function validateCSEConfig() {
            log(`=== VALIDATING CSE CONFIGURATION ===`);
            const networkStatus = document.getElementById('networkStatus');
            networkStatus.textContent = 'Validating CSE...';
            
            // Check if we can access Google Custom Search console info
            try {
                const testResponse = await fetch(`https://www.googleapis.com/customsearch/v1?key=${GOOGLE_API_KEY}&cx=${CSE_ID}&q=test&num=1`);
                const data = await testResponse.json();
                
                if (data.searchInformation) {
                    log(`CSE is valid and accessible`);
                    log(`Total results available: ${data.searchInformation.totalResults}`);
                    log(`Search time: ${data.searchInformation.searchTime}`);
                    networkStatus.textContent = 'CSE configuration valid';
                } else if (data.error) {
                    log(`CSE validation failed: ${data.error.message}`);
                    if (data.error.message.includes('Custom Search Engine')) {
                        log(`CSE ID might be incorrect or CSE might be deleted`);
                        networkStatus.textContent = 'Invalid CSE ID';
                    } else {
                        networkStatus.textContent = `CSE Error: ${data.error.code}`;
                    }
                } else {
                    log(`Unexpected CSE response: ${JSON.stringify(data)}`);
                    networkStatus.textContent = 'Unexpected CSE response';
                }
            } catch (error) {
                log(`CSE validation error: ${error.message}`);
                networkStatus.textContent = 'CSE validation failed';
            }
        }
    </script>
</body>

</html>