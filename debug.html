<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teleprompter & Video Debug Suite (Full Version)</title>
    <script src="https://www.youtube.com/iframe_api"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background: #1a1a2e;
            color: white;
        }

        .debug-section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #444;
            border-radius: 8px;
            background: #2a2a4e;
        }

        .controls {
            margin: 10px 0;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        button {
            padding: 10px 20px;
            font-size: 14px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            background: #4CAF50;
            color: white;
        }

        button:hover {
            background: #45a049;
        }

        button:disabled {
            background: #666;
            cursor: not-allowed;
        }

        .status {
            background: #333;
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            font-family: monospace;
        }

        #teleprompterCanvas {
            border: 2px solid #666;
            width: 100%;
            max-width: 800px;
            height: 400px;
            background: #000;
        }

        #videoContainer {
            position: relative;
            width: 100%;
            max-width: 800px;
            height: 450px;
            background: #000;
            border: 2px solid #666;
        }

        .log {
            background: #1a1a1a;
            padding: 10px;
            height: 200px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
            border: 1px solid #444;
        }
    </style>
</head>

<body>
    <h1>ðŸ”§ Teleprompter & Video Debug Suite (Full Version)</h1>
    <p>The complete test suite with the robust SpeechService architecture integrated.</p>

    <div class="debug-section">
        <h2>ðŸ“‹ Sample Test Data</h2>
        <div class="sample-data">
            <h3>Intro Narration:</h3>
            <p id="introText">"Welcome to our lesson on Machine Learning fundamentals. In this first segment, we'll
                explore the basic concepts that form the foundation of artificial intelligence and data science."</p>
            <h3>Outro Narration:</h3>
            <p id="outroText">"Excellent work! You've now learned the core principles of Machine Learning. These
                concepts will serve as building blocks for more advanced topics in our next lesson."</p>
            <h3>Video Segment:</h3>
            <p><strong>YouTube ID:</strong> <span id="videoId">dQw4w9WgXcQ</span></p>
            <p><strong>Start Time:</strong> <span id="startTime">10</span> seconds</p>
            <p><strong>End Time:</strong> <span id="endTime">40</span> seconds</p>
        </div>
    </div>

    <div class="debug-section">
        <h2>ðŸŽ¤ Speech Synthesis Test</h2>
        <div class="controls">
            <button onclick="SpeechService.play(document.getElementById('introText').textContent)">Test Speech</button>
            <button onclick="SpeechService.pause()">Pause</button>
            <button onclick="SpeechService.resume()">Resume</button>
            <button onclick="SpeechService.stop()">Stop</button>
        </div>
        <div class="status" id="speechStatus">Speech synthesis ready</div>
    </div>

    <div class="debug-section">
        <h2>ðŸ“œ Teleprompter Scrolling Test</h2>
        <canvas id="teleprompterCanvas"></canvas>
        <div class="controls">
            <button onclick="log('Teleprompter test not implemented yet.')">Test Intro Teleprompter</button>
        </div>
        <div class="status" id="teleprompterStatus">Teleprompter ready</div>
    </div>

    <div class="debug-section">
        <h2>ðŸ“¹ YouTube Video Segment Test</h2>
        <div id="videoContainer"></div>
        <div class="controls">
            <button onclick="loadVideoSegment()">Load Video Segment</button>
        </div>
        <div class="status" id="videoStatus">Video player ready</div>
    </div>

    <div class="debug-section">
        <h2>ðŸŽ“ Full Lesson Simulation</h2>
        <div class="controls">
            <button onclick="startFullLesson()" id="startLessonBtn">Start Full Lesson</button>
            <button onclick="skipToNext()" id="skipBtn" disabled>Skip Current</button>
        </div>
        <div class="status" id="lessonStatus">Ready to start lesson</div>
        <div class="status" id="currentPhase">Phase: Idle</div>
    </div>

    <div class="debug-section">
        <h2>ðŸ“Š Debug Log</h2>
        <button onclick="clearLog()">Clear Log</button>
        <div class="log" id="debugLog"></div>
    </div>

    <script>
        // --- UTILITY AND GLOBAL SETUP ---
        function log(message) {
            const logDiv = document.getElementById('debugLog');
            if (logDiv) {
                const timestamp = new Date().toLocaleTimeString();
                logDiv.innerHTML += `[${timestamp}] ${message}<br>`;
                logDiv.scrollTop = logDiv.scrollHeight;
            }
            console.log(`[DEBUG] ${message}`);
        }
        function clearLog() {
            if (document.getElementById('debugLog')) {
                document.getElementById('debugLog').innerHTML = '';
            }
        }
        window.onload = () => {log('Debug suite initialized');};
        window.onYouTubeIframeAPIReady = () => {log('YouTube API ready');};

        // --- GLOBAL STATE ---
        const SpeechService = {state: {}, timer: null, utterance: null};
        let youtubePlayer = null;
        let lessonState = 'idle';

        // --- ROBUST SPEECHSERVICE OBJECT ---
        Object.assign(SpeechService, {
            play(text, config = {}) {
                if (!config.isResume) {
                    this.stop();
                    this.state = {originalText: text, lastSpokenCharIndex: 0, isPlaying: false, onComplete: config.onComplete};
                }
                this.utterance = new SpeechSynthesisUtterance(text);
                this.utterance.onstart = () => {
                    log('Speech playback started.');
                    document.getElementById('speechStatus').textContent = 'Speaking...';
                    this.state.isPlaying = true;
                    const startTime = Date.now();
                    const charsPerSecond = 14;
                    const baseIndex = this.state.originalText.length - text.length;
                    this.timer = setInterval(() => {
                        const elapsedSeconds = (Date.now() - startTime) / 1000;
                        this.state.lastSpokenCharIndex = baseIndex + Math.floor(elapsedSeconds * charsPerSecond);
                    }, 100);
                };
                this.utterance.onend = () => {
                    clearInterval(this.timer);
                    this.state.isPlaying = false;
                    const isFinished = (this.state.lastSpokenCharIndex + 5) >= this.state.originalText.length;
                    if (isFinished) {
                        log('Full text finished.');
                        document.getElementById('speechStatus').textContent = 'Speech complete';
                        if (this.state.onComplete) this.state.onComplete();
                        this.state = {};
                    }
                };
                this.utterance.onerror = (e) => {
                    log(`Speech error: ${e.error}`);
                    clearInterval(this.timer);
                    this.state = {};
                };
                speechSynthesis.speak(this.utterance);
            },
            pause() {
                if (!this.state.isPlaying) return;
                log(`Pausing at char index: ${this.state.lastSpokenCharIndex}`);
                clearInterval(this.timer);
                this.state.isPlaying = false;
                if (this.utterance) this.utterance.onend = null;
                speechSynthesis.cancel();
                document.getElementById('speechStatus').textContent = 'Speech paused';
            },
            resume() {
                if (this.state.isPlaying || !this.state.originalText) return;
                const remainingText = this.state.originalText.substring(this.state.lastSpokenCharIndex);
                if (remainingText.trim() === '') {log('Nothing left to resume.'); return;}
                this.play(remainingText, {isResume: true});
            },
            stop() {
                clearInterval(this.timer);
                if (this.utterance) this.utterance.onend = null;
                speechSynthesis.cancel();
                if (document.getElementById('speechStatus')) document.getElementById('speechStatus').textContent = 'Speech stopped';
                this.state = {};
            }
        });

        // --- FULL LESSON SIMULATION LOGIC ---
        function startFullLesson() {
            log('Starting full lesson simulation');
            lessonState = 'intro';
            updateLessonButtons(true);
            document.getElementById('lessonStatus').textContent = 'Lesson in progress';
            startIntro();
        }
        function startIntro() {
            document.getElementById('currentPhase').textContent = 'Phase: Intro narration';
            const text = document.getElementById('introText').textContent;
            SpeechService.play(text, {onComplete: startVideoPhase});
        }
        function startVideoPhase() {
            log('Intro complete. Starting video phase.');
            lessonState = 'video';
            document.getElementById('currentPhase').textContent = 'Phase: Video segment';
            loadVideoSegment(startOutro); // Pass startOutro as the callback
        }
        function startOutro() {
            log('Video complete. Starting outro narration.');
            lessonState = 'outro';
            if (youtubePlayer) try {youtubePlayer.destroy();} catch (e) { }
            document.getElementById('currentPhase').textContent = 'Phase: Outro narration';
            const text = document.getElementById('outroText').textContent;
            SpeechService.play(text, {onComplete: completeLesson});
        }
        function completeLesson() {
            log('Lesson complete!');
            lessonState = 'complete';
            document.getElementById('currentPhase').textContent = 'Phase: Complete';
            document.getElementById('lessonStatus').textContent = 'Lesson completed successfully!';
            updateLessonButtons(false);
        }
        function skipToNext() {
            log('Skipping to next phase');
            SpeechService.stop();
            if (lessonState === 'intro') startVideoPhase();
            else if (lessonState === 'video') startOutro();
            else if (lessonState === 'outro') completeLesson();
        }
        function updateLessonButtons(lessonActive) {
            document.getElementById('startLessonBtn').disabled = lessonActive;
            document.getElementById('skipBtn').disabled = !lessonActive;
        }

        // --- OTHER STANDALONE FUNCTIONS ---
        function loadVideoSegment(onComplete) {
            const videoId = document.getElementById('videoId').textContent;
            const startTime = parseInt(document.getElementById('startTime').textContent);
            const endTime = parseInt(document.getElementById('endTime').textContent);
            if (youtubePlayer) try {youtubePlayer.destroy();} catch (e) { }
            youtubePlayer = new YT.Player('videoContainer', {
                height: '100%', width: '100%', videoId,
                playerVars: {autoplay: 1, controls: 1, start: startTime, end: endTime},
                events: {
                    onStateChange: (event) => {if (event.data === YT.PlayerState.ENDED && onComplete) onComplete();},
                    onError: (e) => {log(`YouTube error (${e.data}).`); if (onComplete) onComplete();}
                }
            });
        }
    </script>
</body>

</html>